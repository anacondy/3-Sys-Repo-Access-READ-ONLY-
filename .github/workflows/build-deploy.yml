name: Build and Deploy

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # Deploy to GitHub Pages
  deploy-pages:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # Build platform-specific apps
  build-apps:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: |
          npm init -y
          npm install electron electron-builder --save-dev
          
      - name: Create Electron wrapper
        run: |
          mkdir -p electron-app
          cp index.html electron-app/
          cp LICENSE electron-app/
          
          # Create main.js
          cat > electron-app/main.js << 'EOF'
          const { app, BrowserWindow, shell } = require('electron');
          const path = require('path');
          
          function createWindow() {
            const win = new BrowserWindow({
              width: 1280,
              height: 720,
              webPreferences: {
                nodeIntegration: false,
                contextIsolation: true
              },
              icon: path.join(__dirname, 'icon.png'),
              autoHideMenuBar: true,
              backgroundColor: '#050505'
            });
            
            win.loadFile('index.html');
            
            // Open external links in default browser
            win.webContents.setWindowOpenHandler(({ url }) => {
              shell.openExternal(url);
              return { action: 'deny' };
            });
          }
          
          app.whenReady().then(createWindow);
          
          app.on('window-all-closed', () => {
            if (process.platform !== 'darwin') app.quit();
          });
          
          app.on('activate', () => {
            if (BrowserWindow.getAllWindows().length === 0) createWindow();
          });
          EOF
          
          # Create package.json for Electron
          cat > electron-app/package.json << 'EOF'
          {
            "name": "the-archives",
            "version": "1.0.0",
            "description": "Local Media Explorer",
            "main": "main.js",
            "author": "ANACONDY",
            "license": "MIT",
            "build": {
              "appId": "com.anacondy.thearchives",
              "productName": "The Archives",
              "directories": {
                "output": "../dist"
              },
              "win": {
                "target": ["nsis", "portable"]
              },
              "mac": {
                "target": ["dmg"],
                "category": "public.app-category.utilities"
              },
              "linux": {
                "target": ["AppImage", "deb"],
                "category": "Utility"
              }
            }
          }
          EOF
          
      - name: Build for Linux
        run: |
          cd electron-app
          npx electron-builder --linux AppImage deb --publish never
          
      - name: Upload Linux builds
        uses: actions/upload-artifact@v4
        with:
          name: linux-builds
          path: dist/*.AppImage
          
      - name: Upload Debian package
        uses: actions/upload-artifact@v4
        with:
          name: debian-package
          path: dist/*.deb

  # Create release with downloads
  create-release:
    runs-on: ubuntu-latest
    needs: build-apps
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: The Archives ${{ github.ref_name }}
          body: |
            ## The Archives ${{ github.ref_name }}
            
            ### ðŸ“¥ Downloads
            
            #### Desktop Apps
            - **Linux**: Download the AppImage or DEB file below
            - **Windows**: Coming soon (or use the web version)
            - **macOS**: Coming soon (or use the web version)
            
            #### Mobile
            - **Android APK**: Coming soon
            - **iOS**: Use Safari to [add to Home Screen](https://support.apple.com/guide/iphone/bookmark-favorite-webpages-iph42ab2f3a7/ios)
            
            #### Web Version (Recommended)
            ðŸ‘‰ [Launch The Archives](https://anacondy.github.io/3-Sys-Repo-Access-READ-ONLY-/)
            
            ### ðŸ“‹ Installation Instructions
            
            **Linux AppImage:**
            ```bash
            chmod +x TheArchives-*.AppImage
            ./TheArchives-*.AppImage
            ```
            
            **Linux DEB:**
            ```bash
            sudo dpkg -i thearchives_*.deb
            ```
            
            ### âœ¨ What's New
            - Optimized for mobile devices (16:9 and 20:9 aspect ratios)
            - Smooth 60 FPS animations
            - Touch-friendly controls
            - Enhanced documentation
            
          files: |
            release-assets/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
